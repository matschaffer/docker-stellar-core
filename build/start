#!/usr/bin/env bash

set -e

[[ -f stellar-core/autogen.sh ]] || git clone https://github.com/stellar/stellar-core stellar-core

cd stellar-core

DEST="`pwd`/FILES"

rm -rf "${DEST}"
mkdir -p "${DEST}"

./autogen.sh
./configure

make install DESTDIR="${DEST}"

SHA=`git rev-parse HEAD | cut -b1-8`

STELLAR_CORE_VERSION="${VERSION}-${BUILD_NUMBER}-${SHA}"

fpm -s dir -t deb -n stellar-core -v "${STELLAR_CORE_VERSION}" -C "${DEST}" \
    -p stellar-core-VERSION_ARCH.deb \
      usr/local/bin/stellar-core
